FROM debian:bookworm-slim

# Install SSH server, dev tools, and network utilities
RUN apt-get update && apt-get install -y \
    openssh-server \
    git \
    curl \
    vim \
    wget \
    ca-certificates \
    unzip \
    # Network tools
    iproute2 \
    net-tools \
    dnsutils \
    iputils-ping \
    netcat-openbsd \
    traceroute \
    # GitHub CLI
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

# Install Bun (required for PAI)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# Install OpenCode
RUN curl -fsSL https://github.com/anomalyco/opencode/releases/latest/download/opencode-linux-x64.tar.gz -o /tmp/opencode.tar.gz && \
    mkdir -p /root/.opencode/bin && \
    tar -xzf /tmp/opencode.tar.gz -C /tmp && \
    mv /tmp/opencode /root/.opencode/bin/ && \
    chmod +x /root/.opencode/bin/opencode && \
    rm /tmp/opencode.tar.gz

# Install Claude Code (required for PAI's pai CLI)
RUN curl -fsSL https://claude.ai/install.sh | bash
ENV PATH="/root/.local/bin:${PATH}"

# Clone Personal AI Infrastructure (PAI)
RUN git clone https://github.com/danielmiessler/Personal_AI_Infrastructure.git /opt/PAI

# Install PAI v2.5 release to ~/.claude
RUN cp -r /opt/PAI/Releases/v2.5/.claude /root/.claude

# Generate SSH keys for root user
RUN mkdir -p /root/.ssh && \
    ssh-keygen -t rsa -f /root/.ssh/id_rsa -N "" -q

# Set root password for SSH access
RUN echo 'root:password123' | chpasswd

# Add aliases to bashrc
RUN echo 'alias opencode="/root/.opencode/bin/opencode"' >> /root/.bashrc && \
    echo 'alias pai="bun /root/.claude/skills/PAI/Tools/pai.ts"' >> /root/.bashrc && \
    echo 'export PATH="/root/.local/bin:/root/.bun/bin:$PATH"' >> /root/.bashrc

# Configure SSH
RUN mkdir -p /run/sshd && \
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \
    echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config && \
    echo 'PubkeyAuthentication yes' >> /etc/ssh/sshd_config && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Set working directory
WORKDIR /workspace/output

# Expose SSH port
EXPOSE 22

# Start SSH server
CMD ["/usr/sbin/sshd", "-D", "-e"]
